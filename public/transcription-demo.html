<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Transcription Demo</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 20px; color: #00d9ff; }
    .status { text-align: center; padding: 10px; background: #16213e; border-radius: 8px; margin-bottom: 20px; }
    .status.connected { border-left: 4px solid #00ff88; }
    .status.disconnected { border-left: 4px solid #ff4444; }
    .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
    input, select { padding: 10px 15px; border: none; border-radius: 8px; background: #16213e; color: #eee; font-size: 14px; }
    input { flex: 1; min-width: 150px; }
    button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-start { background: #00d9ff; color: #1a1a2e; }
    .btn-start:hover { background: #00b8d9; }
    .btn-stop { background: #ff4444; color: white; }
    .btn-stop:hover { background: #cc3333; }
    .btn-start:disabled, .btn-stop:disabled { opacity: 0.5; cursor: not-allowed; }
    .transcription-box { background: #16213e; border-radius: 12px; padding: 20px; min-height: 300px; max-height: 500px; overflow-y: auto; }
    .transcript-item { padding: 12px; margin-bottom: 10px; border-radius: 8px; background: #0f3460; }
    .transcript-item.interim { background: #1a1a2e; border: 1px dashed #00d9ff; opacity: 0.7; }
    .transcript-item .username { color: #00d9ff; font-weight: 600; margin-bottom: 4px; }
    .transcript-item .text { line-height: 1.5; }
    .transcript-item .time { color: #888; font-size: 12px; margin-top: 4px; }
    .current-speech { background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 20px; min-height: 60px; border: 2px solid #00d9ff; }
    .current-speech.listening { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { border-color: #00d9ff; } 50% { border-color: #00ff88; } }
    .info { background: #16213e; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 14px; line-height: 1.6; }
    .info h3 { color: #00d9ff; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Live Transcription Demo</h1>
    
    <div id="status" class="status disconnected">Connecting to server...</div>
    
    <div class="controls">
      <input type="text" id="roomId" placeholder="Room ID" value="test-room">
      <input type="text" id="username" placeholder="Your Name" value="User">
      <select id="speakingLang">
        <option value="en">Speaking: English</option>
        <option value="es">Speaking: Spanish</option>
        <option value="fr">Speaking: French</option>
        <option value="de">Speaking: German</option>
        <option value="hi">Speaking: Hindi</option>
      </select>
      <select id="targetLang">
        <option value="en">Translate to: English</option>
        <option value="es">Translate to: Spanish</option>
        <option value="fr">Translate to: French</option>
        <option value="de">Translate to: German</option>
        <option value="hi">Translate to: Hindi</option>
      </select>
    </div>
    
    <div class="controls">
      <button id="startBtn" class="btn-start" disabled>Start Transcription</button>
      <button id="stopBtn" class="btn-stop" disabled>Stop Transcription</button>
    </div>
    
    <div id="currentSpeech" class="current-speech">
      <em>Your speech will appear here...</em>
    </div>
    
    <div id="transcriptions" class="transcription-box">
      <div style="color: #888; text-align: center;">Transcriptions from all participants will appear here</div>
    </div>
    
    <div class="info">
      <h3>How it works:</h3>
      <p>1. This uses your browser's built-in Web Speech API (FREE - no API costs!)</p>
      <p>2. Your browser does the speech recognition locally</p>
      <p>3. Text is sent to the server and broadcast to all room participants</p>
      <p>4. Optionally translated to each user's preferred language using AWS Translate</p>
      <p><strong>Note:</strong> Works best in Chrome, Edge, or Safari. Requires microphone permission.</p>
    </div>
  </div>

  <script>
    const socket = io();
    let recognition = null;
    let isListening = false;
    
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const currentSpeechEl = document.getElementById('currentSpeech');
    const transcriptionsEl = document.getElementById('transcriptions');
    const roomIdEl = document.getElementById('roomId');
    const usernameEl = document.getElementById('username');
    const speakingLangEl = document.getElementById('speakingLang');
    const targetLangEl = document.getElementById('targetLang');
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (!SpeechRecognition) {
      statusEl.textContent = 'Browser does not support Speech Recognition. Use Chrome, Edge, or Safari.';
      statusEl.className = 'status disconnected';
    }
    
    socket.on('connect', () => {
      statusEl.textContent = 'Connected to server. Ready to transcribe.';
      statusEl.className = 'status connected';
      startBtn.disabled = !SpeechRecognition;
    });
    
    socket.on('disconnect', () => {
      statusEl.textContent = 'Disconnected from server';
      statusEl.className = 'status disconnected';
      startBtn.disabled = true;
      stopListening();
    });
    
    socket.on('transcription-ready', (data) => {
      console.log('Transcription ready:', data);
      statusEl.textContent = 'Transcription active. Speak now!';
    });
    
    socket.on('transcription', (data) => {
      console.log('Received transcription:', data);
      addTranscription(data);
    });
    
    socket.on('transcription-error', (data) => {
      console.error('Transcription error:', data);
      statusEl.textContent = 'Error: ' + data.error;
    });
    
    function addTranscription(data) {
      const firstChild = transcriptionsEl.firstElementChild;
      if (firstChild && firstChild.style.color === 'rgb(136, 136, 136)') {
        transcriptionsEl.innerHTML = '';
      }
      
      const existingInterim = transcriptionsEl.querySelector(`[data-socket="${data.socketId}"].interim`);
      if (existingInterim) {
        existingInterim.remove();
      }
      
      const item = document.createElement('div');
      item.className = 'transcript-item' + (data.isFinal ? '' : ' interim');
      item.dataset.socket = data.socketId;
      item.innerHTML = `
        <div class="username">${data.username}</div>
        <div class="text">${data.displayedText || data.originalText}</div>
        <div class="time">${new Date(data.timestamp).toLocaleTimeString()}</div>
      `;
      
      if (data.isFinal) {
        transcriptionsEl.appendChild(item);
      } else {
        transcriptionsEl.insertBefore(item, transcriptionsEl.firstChild);
      }
      
      transcriptionsEl.scrollTop = transcriptionsEl.scrollHeight;
    }
    
    function startListening() {
      if (!SpeechRecognition || isListening) return;
      
      const roomId = roomIdEl.value.trim() || 'test-room';
      const username = usernameEl.value.trim() || 'User';
      const speakingLanguage = speakingLangEl.value;
      const targetLanguage = targetLangEl.value;
      
      socket.emit('join-room', { roomId, username });
      
      socket.emit('start-transcription', {
        roomId,
        username,
        speakingLanguage,
        targetLanguage
      });
      
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = speakingLanguage === 'en' ? 'en-US' : 
                         speakingLanguage === 'es' ? 'es-ES' :
                         speakingLanguage === 'fr' ? 'fr-FR' :
                         speakingLanguage === 'de' ? 'de-DE' :
                         speakingLanguage === 'hi' ? 'hi-IN' : 'en-US';
      
      recognition.onstart = () => {
        isListening = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        currentSpeechEl.classList.add('listening');
        currentSpeechEl.innerHTML = '<em>Listening... speak now</em>';
        statusEl.textContent = 'Listening... speak into your microphone';
      };
      
      recognition.onresult = (event) => {
        const result = event.results[event.results.length - 1];
        const transcript = result[0].transcript;
        const isFinal = result.isFinal;
        
        currentSpeechEl.innerHTML = transcript + (isFinal ? ' âœ“' : '...');
        
        socket.emit('browser-transcription', {
          roomId,
          username,
          text: transcript,
          isFinal,
          speakingLanguage,
          targetLanguage
        });
      };
      
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          currentSpeechEl.innerHTML = '<em>No speech detected. Keep talking...</em>';
        } else if (event.error === 'not-allowed') {
          statusEl.textContent = 'Microphone access denied. Please allow microphone access.';
          stopListening();
        } else {
          statusEl.textContent = 'Speech error: ' + event.error;
        }
      };
      
      recognition.onend = () => {
        if (isListening) {
          recognition.start();
        }
      };
      
      recognition.start();
    }
    
    function stopListening() {
      isListening = false;
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      currentSpeechEl.classList.remove('listening');
      currentSpeechEl.innerHTML = '<em>Transcription stopped</em>';
      statusEl.textContent = 'Connected to server. Ready to transcribe.';
      
      socket.emit('stop-transcription', { roomId: roomIdEl.value.trim() });
    }
    
    startBtn.addEventListener('click', startListening);
    stopBtn.addEventListener('click', stopListening);
  </script>
</body>
</html>
