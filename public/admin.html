<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aavrti Powerful Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { height: 100vh; background: #2c3e50; color: white; padding-top: 20px; position: fixed; width: 250px; }
        .main-content { margin-left: 250px; padding: 20px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-card h2 { margin: 0; color: #2c3e50; }
        .stat-card p { color: #7f8c8d; margin: 0; }
        .room-row:hover { background-color: #f1f2f6; cursor: pointer; }
        .badge-room { background-color: #3498db; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3 class="text-center mb-4">Aavrti Admin</h3>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link text-white active" href="#">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link text-white" href="#" onclick="showHistory()">Historical Logs</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Live Server Monitoring</h1>
            <div id="server-status"><span class="badge bg-success">System Online</span></div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="card stat-card">
                    <h2 id="total-rooms">0</h2>
                    <p>Active Rooms</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <h2 id="total-users">0</h2>
                    <p>Live Participants</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <h2 id="uptime">0m</h2>
                    <p>Server Uptime</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <h2 id="cpu-load">0%</h2>
                    <p>CPU Load</p>
                </div>
            </div>
        </div>

        <div id="live-section">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between">
                    <h5 class="mb-0">Active Meeting Rooms</h5>
                    <button class="btn btn-sm btn-primary" onclick="refreshData()">Refresh Live</button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Room ID</th>
                                <th>Host</th>
                                <th>Participants</th>
                                <th>Features Active</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="rooms-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="history-section" style="display:none;">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">DynamoDB Historical Room Logs</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="history-room-id" class="form-control" placeholder="Enter Room ID...">
                        <button class="btn btn-primary" type="button" onclick="fetchHistory()">Fetch History</button>
                    </div>
                    <div id="history-results" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function refreshData() {
            try {
                const res = await fetch('/api/rooms/metrics');
                const data = await res.json();
                document.getElementById('total-rooms').innerText = data.totalRooms;
                document.getElementById('total-users').innerText = data.totalUsers;
                document.getElementById('uptime').innerText = Math.floor(data.uptime / 60) + 'm';
                document.getElementById('cpu-load').innerText = data.cpuLoad + '%';
                
                const table = document.getElementById('rooms-table');
                table.innerHTML = data.rooms.map(room => `
                    <tr>
                        <td><span class="badge badge-room">${room.id}</span></td>
                        <td>${room.hostUsername}</td>
                        <td>${room.userCount}</td>
                        <td>
                            ${room.isRecording ? '<span class="badge bg-danger">REC</span>' : ''}
                            ${room.hasWhiteboard ? '<span class="badge bg-info">Board</span>' : ''}
                        </td>
                        <td>${new Date(room.createdAt).toLocaleTimeString()}</td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function showHistory() {
            document.getElementById('live-section').style.display = 'none';
            document.getElementById('history-section').style.display = 'block';
        }

        async function fetchHistory() {
            const roomId = document.getElementById('history-room-id').value;
            const results = document.getElementById('history-results');
            results.innerHTML = 'Loading...';
            try {
                const res = await fetch(\`/api/rooms/\${roomId}/history\`);
                const data = await res.json();
                results.innerHTML = data.map(item => \`
                    <div class="border-bottom py-2">
                        <span class="badge bg-secondary">\${item.type}</span>
                        <small class="text-muted">\${new Date(item.timestamp).toLocaleString()}</small>
                        <pre class="bg-light p-2 mt-1">\${JSON.stringify(item, null, 2)}</pre>
                    </div>
                \`).join('') || 'No history found.';
            } catch (e) { results.innerHTML = 'Error fetching history'; }
        }

        setInterval(refreshData, 5000);
        refreshData();
    </script>
</body>
</html>